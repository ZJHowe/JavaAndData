# 操作系统文件与文件管理相关

## 一、文件的基础概念
&emsp;&emsp;文件是一组有意义的数据集合，主要包含**文件名**、**标识符**、**类型**、**位置**、**大小**、**创建时间**、**上次修改时间**、**文件所有者信息**、**保护信息**等属性。

 - 文件数据的组成：
 ![文件数据的组成](https://img-blog.csdnimg.cn/20210301144747130.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODgzNjI3Mw==,size_16,color_FFFFFF,t_70#pic_center)
 - 文件的组织结构（树状）：
 ![文件组织结构](https://img-blog.csdnimg.cn/20210301145022205.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODgzNjI3Mw==,size_16,color_FFFFFF,t_70#pic_center)
## 二、文件的逻辑结构
- **无结构文件**：文件内部的数据就是一系列二进制流或字符流组成，又称**流式文件**（如windows操作系统下的.txt文件）。
- **有结构文件**：由一组相似的记录组成，又称**记录式文件**。每条记录又由若干个数据项组成（如数据库表文件，一般来说每条记录会有一个数据项作为**关键字**）。根据各条记录的长度是否相等，又可分为**定长记录**和**可变长记录**。
![结构文件的逻辑结构](https://img-blog.csdnimg.cn/20210301152048826.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODgzNjI3Mw==,size_16,color_FFFFFF,t_70#pic_center)
## 三、文件目录
### 3.1 文件控制块
![目录文件](https://img-blog.csdnimg.cn/20210301153726271.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODgzNjI3Mw==,size_16,color_FFFFFF,t_70#pic_center)
&emsp;&emsp;图中，目录文件中的一条记录就是一个**文件控制块(FCB)**，包含了文件的基本信息、存取控制信息和使用信息。其中，**文件名和文件存放物理地址的映射关系**最为重要。
### 3.2 目录结构
- 单级目录结构：早期操作系统不支持多级目录，整个系统中只建立一张目录表，每个文件占一个目录项。
- 两级目录结构：早期多用户操作系统采用两级目录结构，分为**主文件目录**和**用户文件目录**。
![两级目录结构](https://img-blog.csdnimg.cn/20210301154553760.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODgzNjI3Mw==,size_16,color_FFFFFF,t_70#pic_center)
- **多级目录结构(树形)**：现代操作系统常用的目录结构，但**不便于文件共享**
![多级目录结构](https://img-blog.csdnimg.cn/20210301154830100.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODgzNjI3Mw==,size_16,color_FFFFFF,t_70#pic_center)
&emsp;&emsp;其中，从根目录出发的路径称为绝对路径。系统根据绝对路径层级寻找下级目录，首先从外存中读入根目录的目录表，再从外存中读入二级目录的目录表，以此进行直至找到对应文件，整个过程需要**多次读磁盘I/O操作**。而用户所在目录的目录表已掉入内存，那么可以将他设置为“当前目录”，用户想要访问某个文件时，可以使用从当前目录出发的**相对路径**，从而**减少磁盘I/O的次数**。
- **无环图目录结构**：可以用**不同的文件名指向同一个文件**，甚至指向同一个目录。
- **索引节点**：将除了文件名外的所有信息都放入索引节点中，每个目录项长度大幅度减小，从而减少磁盘I/O次数。
## 四、文件的物理结构
### 4.1 文件块与磁盘块
&emsp;&emsp;**在很多操作系统中，磁盘块的大小与内存块、页面大小相同**。同样的，为了方便对文件数据的管理，**文件的逻辑地址空间也被分为了文件块**（表现为逻辑块号和块内地址）。
![文件块与磁盘块](https://img-blog.csdnimg.cn/20210301162443166.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODgzNjI3Mw==,size_16,color_FFFFFF,t_70#pic_center)
### 4.2 文件分配方式
- **连续分配**：每个文件在磁盘上占有一组连续的块。同时文件目录中记录必须存放**起始块号**和**长度**（物理块号=起始块号+逻辑块号，支持顺序和随机访问）。**连续分配文件在顺序读/写时速度最快**，但不方便拓展且容易出现磁盘碎片。
- **链接分配**：
隐式链接——目录中记录了文件的**起始块号和结束块号**，并且在磁盘中除了最后一个磁盘块外，每个磁盘块中都保存指向下个块的指针（只支持顺序访问，不支持随机访问）。但方便文件拓展（只需要将新的文件块挂到文件磁盘块链尾，并修改文件FCB），不会有外存碎片问题。
显示链接——文件目录中只需记录文件的**起始块号**，将用于链接这个物理块与下个物理块的指针显示地放在一张表中，即**文件分配表**（FAT，每个磁盘一个表，常驻内存）。由于FAT的存在，显示链接的文件支持顺序访问也支持随机访问，并且不会产生外部碎片，也可以方便地对文件进行拓展。
- **索引分配**：在显示链接中，每个磁盘对应一张FAT表，而**索引分配**是一**个文件对应一张索引表**每个文件的目录中记录索引表所在的物理块。并且将物理块号定长表示，则**逻辑块号可以是隐含的**。
![索引分配](https://img-blog.csdnimg.cn/20210301193310535.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODgzNjI3Mw==,size_16,color_FFFFFF,t_70#pic_center=400x300)
由索引表可以知道，索引分配方式支持随机访问，且文件拓展也容易实现。但是如果**索引表太大**，一个索引块装不下，可以用**链接方案**（链接多个索引块，磁盘I/O过多导致低效）、**多层索引**（类似多级页表，各层索引表不超过一个磁盘块）、**混合索引**（多种索引方式的结合，对小文件来说磁盘I/O少）

总结文件分配方式：
|  | 思想 | 目录项内容 | 优点 | 缺点 |
|--|--|--|--|--|
| 顺序分配 | 为文件分配的必须是连续的磁盘块 | 起始块号、文件长度 | 顺序存取速度快，支持随机访问 | 会产生碎片，不利于文件拓展 |
| 隐式链接 | 除文件的最后一个盘块之外，每个盘块中都存有指向下一个盘块的指针 | 起始块号、结束块号 | 可解决碎片问题，外存利用率高，文件拓展实现方便 | 只能顺序访问，不能随机访问 |
| 显式链接 | 建立一张文件分配表(FAT) 显式记录盘块的先后关系 (开机后FAT常驻内存) | 起始块号 | 除了拥有隐式链接的优点之外，还可通过查询内存中的FAT实现随机访问 | FAT需要占用一定的存储空间 |
| **索引分配** | 为文件数据块建立索引表太大，可采用链接方案、多层索引、混合索引 | 链接方案记录的是第一个索引块的块号，多层/混合索引记录的是顶级索引块的块号 | 支持随机访问，易于实现文件的拓展 | 索引表需占用一定的存储空间。访问数据块前需要先读入索引块。若采用链接方案，查找索引块时可能需要很多次读磁盘操作。 |
## 五、文件存储空间管理
&emsp;&emsp;**磁盘分区**是指将物理磁盘划分为一个个**文件卷**，每个文件卷分为**目录区**（主要存放文件目录信息(FCB)和用于磁盘存储空间管理的信息）和**文件区**。

&emsp;&emsp;文件的存储空间管理方法如下：
- **空闲表法**：类似内存空间管理中连续存储中动态分区的情况，适用于文件物理结构是连续分配的场景。空闲表中记录第一个空闲盘块号和连续空闲盘块数。
- **空闲链表法**：又分为**空闲盘块链**和**空闲盘区链**
&emsp;**空闲盘块链**中操作系统**保存链头和链尾指针**，分配时从链头取出，回收时挂在链尾。
&emsp;**空闲盘区链**中操作系统同样**保存链头和链尾指针**，分配时通过动态分区方法寻找到一个合适的区域（可以将不同盘区的盘块分配），回收时回收区域与空闲盘区相邻则合并，不相邻则挂到链尾，特点是离散和连续分配都适用。\
![空闲盘块链](https://img-blog.csdnimg.cn/20210301204927108.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODgzNjI3Mw==,size_16,color_FFFFFF,t_70=250x300) 
![空闲盘区链](https://img-blog.csdnimg.cn/2021030120492784.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODgzNjI3Mw==,size_16,color_FFFFFF,t_70=350x300)
- **位示图法**：通过字号和位号来映射到对应的盘块号。分配时，顺序扫面位示图，找到N个相邻或不相邻的0，映射到盘块号进行分配，并将对应位置置1。回收时，根据盘块号得到字号和位号，并将相应位置置0。

![位示图法](https://img-blog.csdnimg.cn/20210301210351210.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODgzNjI3Mw==,size_16,color_FFFFFF,t_70#pic_center)
- **成组链接法**：空闲表法和空闲链表法由于空闲表或空闲链表过大不适用于大型文件系统。UNIX中采用了成组链接法。文件卷的目录区中专门用一个磁盘块作为**超级块**，当系统启动时将超级块读入内存，并保证内外存中超级块数据一致。超级块中保存本组空闲盘块数和空闲盘块号(B+树，直至用特殊值-1表示无下组空闲块)。

## 六、文件的基本操作
> - **创建文件**：调用了”**Create系统调用”**，需要提供所需外存空间大小、文件存放路径、文件名这些主要参数。操作系统处理Create系统调用主要做了两件事情：(1)**在外存中找到文件所需的空间**(空闲链表法、成组链接法等)。(2)**创建该文件对应的目录项**。
> -  **删除文件**：调用了“**Delete系统调用**”，需要提供文件存放路径和文件名参数。操作系统处理Delete系统调用时，首先**找到文件名对应的目录项**，然后**回收文件占用的磁盘块**，最后**删除文件对应的目录项**。
> - **打开文件**：调用了“**Open系统调用**”，需要提供文件存放路径、文件名和对文件操作类型这些主要信息。操作系统处理Open系统调用时，首先**找到文件名对应的目录项**，如果用户有操作权限则**将目录项复制到内存中的打开文件表中**(加快打开文件的访问速度，系统和各进程都有自己的打开文件表)。
>  - **关闭文件**：调用的“**Close系统调用**”，操作系统**将进程的打开文件表对应表项删除**，然后**回收分配给该文件的内存空间等资源**，最后**将系统打开文件表中打开计数器count-1，如果count=0，则删除对应表项**。
>  - **读写文件**：调用“**Read/Write系统调用**”，需要指明打开文件表中对应的索引号、数据大小和写入内存/外存中存放的地址。
## 七、文件共享
&emsp;&emsp;文件的共享，意味着多个用户共享同一个文件，也就是系统中只有一份文件数据。文件共享分为：
> - 基于索引节点的共享方式(**硬链接**)：多个用户文件名对应的索引节点指针可以指向同一个索引节点，并在索引节点中用Count记录文件共享用户数量。
> - 基于符号链的共享方式(**软链接**)：使用Link类型的文件，通过其中记录的想要共享的文件存放路径来实现访问(快捷方式)。

------
参考：《王道考研操作系统》
地址：https://www.bilibili.com/video/BV1YE411D7nH
