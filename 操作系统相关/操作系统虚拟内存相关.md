# 操作系统虚拟内存相关

## 一、虚拟内存的基本概念
&emsp;&emsp;由内存管理相关知识可以知道，**虚拟存储技术**是内存空间扩充的相关技术，在传统内存管理方式的基础上，结合内存扩充技术能够从逻辑上扩充内存容量。\
&emsp;&emsp;**==传统内存管理技术==需要将作业一次性全部装入内存后开始运行**，这会导致两个问题：\
&emsp;&emsp;&emsp;①作业很大时，不能全部装入内存，**大作业无法运行**。\
&emsp;&emsp;&emsp;②大量作业并发请求运行，内存限制使得**多道程序并发度下降**。并且**作业一旦被转入内存，就会一直驻留内存**。\
&emsp;&emsp;以上的问题可以通过**虚拟存储技术**解决。在介绍虚拟存储技术前需要知道**局部性原理**：

 > - **时间局部性**：如果执行了程序中某条指令，那么这条指令很可能再次执行；如果某个数据被访问过，那么不久后这个数据很可能被再次访问。（程序中的大量循环）
 > - **空间局部性**：一旦程序访问了某个存储单元，不久后，其附近的存储单元也很可能被访问。（很多数据在内存中是连续存放的，指令也是顺序存放在内存中的）
 由此，应用局部性原理，可以使用**高速缓存思想**：将近期会频繁访问的数据放入更高速的存储器中，暂时不用的存放在低速存储器中。
 ![存储器层次结构](https://img-blog.csdnimg.cn/20210301110909297.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODgzNjI3Mw==,size_16,color_FFFFFF,t_70#pic_center)
 
**==虚拟内存==**：运用局部性原理，操作系统将程序转入内存时，会**将很快就会用到的部分装入内存，暂时不用的部分留在外存**；在程序执行过程中，**访问信息不在内存时，操作系统给将其从外存调入内存**；当内存容量不够时，**操作系统将内存中暂时不同的信息换出到外存**。这样可以得到比实际内存大得多的内存，称为**虚拟内存**（操作系统虚拟性的一个体现）。\
&emsp;&emsp;**虚拟内存计算建立在离散分配的内存管理方式基础上**。在传统离散内存管理技术之上，提出了**请求分页存储管理方式**，操作系统要实现信息从内存和外存的变换，需要提供**调页(或调段)** 和 **页面置换(或段置换)** 功能：
1. **页表机制**：为了实现调页和页面置换，需要为页表增加更多的字段来记录页的状态。
 ![请求分页存储的页表机制](https://img-blog.csdnimg.cn/20210301131754744.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zODgzNjI3Mw==,size_16,color_FFFFFF,t_70#pic_center)
2. **缺页中断机构**：\
 &emsp;&emsp;在请求分页系统中，每当要访问的**页面不在内存时**，便**产生一个缺页中断**（内中断），然后由操作系统的缺页中断处理程序处理中断。此时**缺页的进程阻塞**，放入阻塞队列，**调页完成后再将其唤醒**，放回就绪队列。\
 &emsp;&emsp;如果**内存中有空闲块**，则**为进程分配一个空闲块**，将所缺页面装入该块，并修改页表中相应的页表项；如果**内存中没有空闲块**，则**由页面置换算法选择一个页面淘汰**，**若该页面在内存期间被修改过**，则要将其**写回外存**，未修改过的页面不用写回外存。
## 二、页面置换算法
 &emsp;&emsp;**页面置换算法**就是用于页面置换时，遵循哪种方法选择需要调出内存的页面（追求最小缺页率）。
 - **最佳置换算法**：每次选择淘汰的页面将是以后永不使用，或者在最长时间内不再被访问的页面，这样可以保证最低的缺页率。（无法实现）
 - **先进先出置换算法(FIFO)**:每次选择淘汰的页面是最在进入内存的页面。（算法性能差）
 - **最近最久未使用置换算法(LRU)**：淘汰最近最久未使用的页面。（算法性能好，但是需要特定硬件支持，ps：leetcode有算法题）
 - **时钟置换算法(NRU)**：简单的CLOCK算法的实现是为每个页面设置一个**访问位**，并将内存中的页面都通过链接指针链接成一个循环队列。当某页面被访问时，其访问位为1。当需要淘汰一个页面时，只需检查页的访问位。 如果是0，就选择该页换出;如果是1，则将它置为0，暂不换出，继续检查下一个页面，若第一轮扫描中所有页面都是1，则将这些页面的访问位依次置为0后，再进行第二轮扫描(第二轮扫描中一定会有访问位为0的页面，因此**简单的CLOCK 算法选择一个淘汰页面最多会经过两轮扫描**)

------
参考：《王道考研操作系统》
地址：https://www.bilibili.com/video/BV1YE411D7nH
